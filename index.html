<!DOCTYPE html>
<html lang="en">

<!-- 
MCYM BONN/K√ñLN EVENTS CALENDAR - LATEST VERSION
===============================================

üÜï LATEST FEATURES & FIXES:
--------------------------
‚úÖ Fixed countdown logic (shows "Tomorrow" correctly for next-day events)
‚úÖ Anti-abuse protection (30s cooldown, max 5 refreshes/hour)
‚úÖ Bot detection (automatically hides refresh button from bots)
‚úÖ Dual API key system for security
‚úÖ Enhanced error handling for missing static files
‚úÖ Improved date/time calculations

DUAL API KEY SETUP:
-------------------
This calendar uses TWO different Google API keys for security:

1. UNRESTRICTED KEY (GitHub Actions): Stored in GitHub repository secrets as GOOGLE_API_KEY
   - Used by GitHub Actions to fetch calendar data
   - No domain restrictions (needed for GitHub's servers)
   - Only has Google Calendar API access

2. RESTRICTED KEY (Website): Hardcoded in the CONFIG below
   - Used by the website for live API calls
   - Restricted to your GitHub Pages domain
   - Only has Google Calendar API access

TO SETUP:
1. Create both keys in Google Cloud Console
2. Set the unrestricted key in GitHub Secrets
3. Replace 'YOUR_RESTRICTED_API_KEY_HERE' below with your restricted key

BADGE CUSTOMIZATION GUIDE:
--------------------------
You can control event badges in three ways:

1. AUTOMATIC: Based on keywords in event title/description
   - "Holy Qurbana" ‚Üí Mass badge  
   - "Youth Fellowship" ‚Üí Youth badge
   - "Food Drive" ‚Üí Service badge
   - "Prayer Vigil" ‚Üí Prayer badge
   - "Retreat" ‚Üí Retreat badge
   - "Bible Study" ‚Üí Meeting badge

2. MANUAL OVERRIDE: Add "badge" property to your event data
   Example: { title: "Special Event", badge: "special", ... }

3. AVAILABLE BADGE TYPES:
   - mass (purple) - for liturgy/qurbana
   - youth (pink) - for fellowship/youth events  
   - service (yellow) - for charity/volunteer
   - prayer (blue) - for prayer/vigil events
   - retreat (green) - for retreats/formation
   - meeting (orange) - for study/meetings
   - social (purple) - for social events
   - special (light green) - for special occasions

ANTI-ABUSE PROTECTION:
---------------------
‚úÖ 30-second cooldown between manual refreshes
‚úÖ Maximum 5 refreshes per hour per user
‚úÖ 1-hour block if limits exceeded
‚úÖ Automatic bot detection and blocking
‚úÖ F5/Ctrl+R protection
‚úÖ Visual feedback for users

SAMPLE events.json STRUCTURE:
----------------------------
{
  "lastUpdated": "2024-01-01T10:00:00Z",
  "totalEvents": 6,
  "source": "google-calendar-api",
  "events": [
    {
      "id": "event1",
      "title": "Sunday Holy Qurbana",
      "description": "Weekly worship service for the community",
      "start": "2024-06-02T10:00:00Z",
      "end": "2024-06-02T12:00:00Z",
      "location": "St. Thomas Church, Bonn",
      "htmlLink": "https://calendar.google.com/calendar/event?eid=...",
      "badge": "mass"
    }
  ]
}
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCYM Bonn/K√∂ln Events Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Static gradient background - no animation */
        body {
            background: linear-gradient(-45deg, #667eea, #764ba2, #4ecdc4, #45b7d1);
            background-attachment: fixed;
        }

        /* Floating particles animation */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 20s infinite linear;
            will-change: transform, opacity;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Glass morphism effect with better text contrast */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Enhanced card hover effects */
        .calendar-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .calendar-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced event cards */
        .event-card {
            transition: all 0.3s ease;
            transform: translateY(0);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .event-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .event-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        .event-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.08);
            transform: rotate(45deg);
            transition: transform 0.4s ease;
        }

        .event-card:hover .event-header::before {
            transform: rotate(45deg) translate(40px, 40px) scale(1.1);
        }

        .event-date-block {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .event-day {
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 2px;
        }

        .event-month-year {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .countdown-badge {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .countdown-today {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .countdown-tomorrow {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
        }

        .countdown-soon {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }

        .countdown-later {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .event-content {
            padding: 20px;
            background-color: white;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .event-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .event-details {
            margin-bottom: 16px;
        }

        .event-detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #2d3748;
            font-weight: 500;
        }

        .event-detail-icon {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            color: #667eea;
            flex-shrink: 0;
        }

        .event-description {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 0 8px 8px 0;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #1a202c;
            font-weight: 400;
            flex-grow: 1;
        }

        .event-description-empty {
            display: none;
        }

        .event-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: auto;
            padding-top: 16px;
        }

        .event-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        /* Enhanced event type badges */
        .event-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: inline-block;
        }

        .badge-mass {
            background: linear-gradient(135deg, #ddd6fe, #c7d2fe);
            color: #5b21b6;
        }

        .badge-retreat {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
        }

        .badge-service {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
        }

        .badge-prayer {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }

        .badge-youth {
            background: linear-gradient(135deg, #fed7e2, #fbb6ce);
            color: #be185d;
        }

        .badge-meeting {
            background: linear-gradient(135deg, #fef0e5, #fed7b2);
            color: #d97706;
        }

        .badge-social {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            color: #7c3aed;
        }

        .badge-special {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: #166534;
        }

        .badge-default {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #374151;
        }

        /* Mobile responsiveness for enhanced cards */
        @media (max-width: 640px) {
            .event-header {
                padding: 12px;
            }

            .event-content {
                padding: 16px;
            }

            .event-title {
                font-size: 1.1rem;
            }

            .event-actions {
                flex-direction: column;
            }

            .event-action-btn {
                min-width: unset;
            }

            .event-date-block {
                padding: 8px;
                margin-bottom: 8px;
            }

            .event-day {
                font-size: 1.25rem;
            }

            .countdown-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
        }

        /* Enhanced loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Status indicators with enhanced visibility */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .status-live {
            background-color: #10b981;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2), 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .status-upcoming {
            background-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2), 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .status-error {
            background-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2), 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .status-warning {
            background-color: #f59e0b;
            animation: pulse 3s infinite;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2), 0 0 20px rgba(245, 158, 11, 0.3);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* Pulsing elements */
        .pulse-slow {
            animation: pulse-icon 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-icon {
            50% {
                opacity: .5;
            }
        }

        /* Calendar iframe styling */
        .calendar-iframe-container {
            position: relative;
            width: 100%;
            height: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            transition: transform 0.3s ease-out;
        }

        .calendar-iframe-container:hover {
            transform: scale(1.01);
        }

        .calendar-iframe-container iframe {
            width: 100% !important;
            height: 600px !important;
            border: none !important;
            border-radius: 8px;
            display: block;
        }

        @media (min-width: 640px) {
            .calendar-iframe-container iframe {
                height: 650px !important;
            }
        }

        @media (min-width: 768px) {
            .calendar-iframe-container iframe {
                height: 700px !important;
            }
        }

        @media (min-width: 1024px) {
            .calendar-iframe-container iframe {
                height: 800px !important;
            }
        }

        /* Scroll reveal animation */
        .reveal {
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.6s ease-out;
            will-change: opacity, transform;
        }

        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Enhanced typography */
        .gradient-text {
            background: linear-gradient(135deg, #fde047, #facc15, #eab308);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        .header-gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        /* Anti-abuse button protection styles */
        .refresh-button-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .refresh-button-cooldown {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        .refresh-button-blocked {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
        }
    </style>
</head>

<body class="text-gray-800 antialiased overflow-x-hidden">

    <div id="particles-container" class="fixed inset-0 pointer-events-none z-0"></div>

    <header class="relative z-10 glass shadow-2xl">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 text-center">
            <div class="flex flex-col sm:flex-row justify-center items-center mb-4 sm:mb-6">
                <div class="relative mb-3 sm:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor"
                        class="w-8 h-8 sm:w-10 sm:h-10 lg:w-12 lg:h-12 sm:mr-4 text-white pulse-slow">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12v-.008ZM12 18h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75v-.008ZM9.75 18h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5v-.008ZM7.5 18h.008v.008H7.5v-.008ZM14.25 15h.008v.008H14.25v-.008ZM14.25 18h.008v.008H14.25v-.008ZM16.5 15h.008v.008H16.5v-.008ZM16.5 18h.008v.008H16.5v-.008Z" />
                    </svg>
                    <div class="absolute -inset-2 sm:-inset-3 bg-white/20 rounded-full blur-xl"></div>
                </div>
                <h1
                    class="text-2xl sm:text-4xl lg:text-5xl font-bold tracking-tight text-white text-center sm:text-left">
                    MCYM <span class="header-gradient-text block sm:inline">Bonn/K√∂ln</span>
                </h1>
            </div>
            <p class="text-lg sm:text-xl lg:text-2xl font-medium text-white mb-3 sm:mb-4">Events Calendar</p>
            <p
                class="text-base sm:text-lg lg:text-xl text-white/95 max-w-2xl mx-auto leading-relaxed px-4 sm:px-0 font-medium">
                Discover all our upcoming events and activities. Stay connected with the Malankara Catholic Youth
                Movement community calendar.
            </p>

            <div class="flex justify-center items-center mt-6 sm:mt-8 space-x-4">
                <span id="calendar-status" class="status-indicator status-live"></span>
                <span class="text-white text-sm font-medium" id="status-text">Loading calendar data...</span>
                <button id="refresh-btn" onclick="refreshCalendar()"
                    class="px-4 py-2 bg-white/25 hover:bg-white/35 rounded-lg text-sm text-white transition-colors flex items-center space-x-2 focus:outline-none focus:ring-2 focus:ring-white/50 font-medium"
                    title="Refresh calendar events"> <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
            <div class="flex justify-center mt-2">
                <span class="text-white/80 text-xs font-medium" id="last-updated"></span>
            </div>

            <div class="flex justify-center space-x-4 sm:space-x-8 mt-6 sm:mt-8">
                <div class="text-center p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <div class="text-xl sm:text-2xl font-bold text-white">‚õ™</div>
                    <div class="text-xs sm:text-sm text-white/80">Faith Events</div>
                </div>
                <div class="text-center p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <div class="text-xl sm:text-2xl font-bold text-white">üåç</div>
                    <div class="text-xs sm:text-sm text-white/80">Bonn & K√∂ln</div>
                </div>
                <div class="text-center p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <div class="text-xl sm:text-2xl font-bold text-white">üë•</div>
                    <div class="text-xs sm:text-sm text-white/80">Youth Community</div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16 relative z-10">

        <div class="glass rounded-2xl overflow-hidden shadow-2xl mb-12 reveal">
            <div class="p-4 sm:p-6 bg-gradient-to-r from-indigo-500/20 to-purple-600/20">
                <h2 class="text-xl sm:text-2xl font-bold text-white mb-2 text-center">üóìÔ∏è Upcoming Events</h2>
                <p class="text-white text-center text-base sm:text-lg font-medium" id="upcomingEventsTitle">Loading
                    exciting
                    events...</p>
                <p class="text-white/90 text-center text-sm sm:text-base mt-2 font-medium">Click "Add to Calendar" to
                    save the date!
                </p>
            </div>
            <div class="p-4 sm:p-6 bg-white/98 backdrop-blur-sm">
                <div id="upcomingEvents" class="grid gap-6" style="display: none;">
                </div>
                <div id="loadingEvents" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    <div class="loading-skeleton h-72"></div>
                    <div class="loading-skeleton h-72"></div>
                    <div class="loading-skeleton h-72"></div>
                    <div class="loading-skeleton h-72"></div>
                    <div class="loading-skeleton h-72"></div>
                    <div class="loading-skeleton h-72"></div>
                </div>
                <div id="noEventsMessage" class="text-center py-8 sm:py-10" style="display: none;">
                    <div class="text-4xl sm:text-6xl mb-3 sm:mb-4">üïäÔ∏è</div>
                    <p class="text-gray-800 text-lg sm:text-xl font-semibold">No upcoming events scheduled at the
                        moment.</p>
                    <p class="text-base sm:text-lg text-gray-600 mt-2 font-medium">Please check back soon for new
                        activities and
                        gatherings!</p>
                </div>
                <div id="errorMessage" class="text-center py-8 sm:py-10" style="display: none;">
                    <div class="text-4xl sm:text-6xl mb-3 sm:mb-4">üò•</div>
                    <p class="text-red-700 text-lg sm:text-xl font-semibold">Oops! We couldn't load the events.</p>
                    <p class="text-base sm:text-lg text-gray-600 mt-2 font-medium">Please try refreshing or check your
                        internet
                        connection. If the issue persists, the events data might be updating.</p>
                    <button onclick="refreshCalendar()"
                        class="mt-6 px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium flex items-center justify-center mx-auto shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Try Again
                    </button>
                </div>
            </div>
        </div>

        <div class="calendar-card glass rounded-2xl overflow-hidden shadow-2xl reveal">
            <div class="p-6 bg-gradient-to-r from-indigo-500/20 to-purple-600/20">
                <h2 class="text-2xl font-bold text-white mb-2 text-center">üìÖ Full Event Calendar</h2>
                <p class="text-white/80 text-center">Explore all activities - click on any event for more details.</p>
            </div>
            <div class="calendar-iframe-container">
                <iframe
                    src="https://calendar.google.com/calendar/embed?src=ce68c51efd70dea3bb00658ca61427f860a2902e62894b09434ef0ba6b881b05%40group.calendar.google.com&ctz=Europe%2FBerlin"
                    frameborder="0" scrolling="no" title="MCYM Bonn/K√∂ln Events Calendar" loading="lazy"> </iframe>
                <noscript>
                    <div class="p-4 text-center text-white">
                        <p>Your browser does not support iframes, or JavaScript is disabled.</p>
                        <p>Please visit the calendar directly at:
                            <a href="https://calendar.google.com/calendar/embed?src=ce68c51efd70dea3bb00658ca61427f860a2902e62894b09434ef0ba6b881b05%40group.calendar.google.com&ctz=Europe%2FBerlin"
                                target="_blank" class="text-yellow-300 hover:text-yellow-400 underline">MCYM
                                Calendar</a>
                        </p>
                    </div>
                </noscript>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mt-12">
            <div class="glass rounded-xl p-6 text-white reveal hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-xl font-semibold mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-6 h-6 mr-2 text-yellow-300">
                        <path fill-rule="evenodd"
                            d="M9.315 7.584C12.195 3.883 16.695 1.5 21.75 1.5a.75.75 0 0 1 .75.75c0 5.056-2.383 9.555-6.084 12.436A6.75 6.75 0 0 1 9.75 22.5a.75.75 0 0 1-.75-.75v-4.131A15.838 15.838 0 0 1 6.382 15H2.25a.75.75 0 0 1-.75-.75 6.75 6.75 0 0 1 7.815-6.666ZM15 6.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z"
                            clip-rule="evenodd" />
                        <path
                            d="M5.26 17.242a.75.75 0 1 0-.897-1.203 5.243 5.243 0 0 0-2.05 5.022.75.75 0 0 0 .897 1.203A6.745 6.745 0 0 1 5.26 17.242Z" />
                    </svg>
                    About MCYM
                </h3>
                <p class="text-white text-base leading-relaxed font-medium mb-4">
                    The Malankara Catholic Youth Movement (MCYM) is the official youth wing of the globally spread
                    Syro-Malankara Catholic Church, focusing on the spiritual development of youth aged 15-35 years in
                    accordance with Catholic teachings and values. Founded in 1971 under Rev Fr Dominic Skariah with the
                    benediction of Archbishop Benedict Gregorios, MCYM operates at Unit, Regional, Diocesan and Church
                    levels across India, North America, Germany, and the Middle East.
                </p>
                <p class="text-white text-base leading-relaxed font-medium mb-4">
                    With its Central Secretariat established in 1990 and a unified constitution promulgated in 1992,
                    MCYM brings together youth from scattered mission regions worldwide to ensure a strong foundation
                    for the Church through faith formation, spiritual growth, and active participation in church and
                    community life.
                </p>
                <div class="mt-4">
                    <a href="https://www.malankaracatholic.de/index.php/apostolates/mcym.html" target="_blank"
                        class="inline-flex items-center px-4 py-2 bg-yellow-400/30 hover:bg-yellow-500/40 text-yellow-100 rounded-lg text-sm font-semibold transition-colors mr-3 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            class="w-5 h-5 mr-2">
                            <path fill-rule="evenodd"
                                d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-3.5a.75.75 0 00-1.5 0v2.75h-7v-7h2.75a.75.75 0 000-1.5h-3.5z"
                                clip-rule="evenodd" />
                            <path fill-rule="evenodd"
                                d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z"
                                clip-rule="evenodd" />
                        </svg>
                        Learn More About MCYM Germany
                    </a>
                </div>
            </div>
            <div class="glass rounded-xl p-6 text-white reveal hover:shadow-lg transition-shadow duration-300">
                <h3 class="text-xl font-semibold mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-6 h-6 mr-2 text-yellow-300">
                        <path d="M12 7.5a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" />
                        <path fill-rule="evenodd"
                            d="M1.5 4.875C1.5 3.839 2.34 3 3.375 3h17.25c1.035 0 1.875.84 1.875 1.875v9.75c0 1.036-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 0 1 1.5 14.625v-9.75ZM8.25 9.75a3.75 3.75 0 1 1 7.5 0 3.75 3.75 0 0 1-7.5 0ZM18.75 9a.75.75 0 0 0-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 0 0 .75-.75V9.75a.75.75 0 0 0-.75-.75h-.008ZM4.5 9.75A.75.75 0 0 1 5.25 9h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V9.75Z"
                            clip-rule="evenodd" />
                        <path
                            d="M12 12.75a.75.75 0 0 0 .75-.75v-.007a.75.75 0 0 0-.75-.75h-.007a.75.75 0 0 0-.75.75v.007a.75.75 0 0 0 .75.75h.007ZM14.25 10.5a.75.75 0 0 0-.75.75v.008a.75.75 0 0 0 .75.75h.008a.75.75 0 0 0 .75-.75v-.008a.75.75 0 0 0-.75-.75h-.008ZM9.75 10.5a.75.75 0 0 0-.75.75v.008a.75.75 0 0 0 .75.75h.008a.75.75 0 0 0 .75-.75v-.008a.75.75 0 0 0-.75-.75H9.75Z" />
                    </svg>
                    Stay Connected
                </h3>
                <p class="text-white text-base leading-relaxed font-medium">
                    Never miss an update! Subscribe to our Google Calendar or follow our community channels for the
                    latest announcements, event details, and fellowship opportunities.
                </p>
                <div class="mt-4">
                    <a href="https://calendar.google.com/calendar/embed?src=ce68c51efd70dea3bb00658ca61427f860a2902e62894b09434ef0ba6b881b05%40group.calendar.google.com&ctz=Europe%2FBerlin"
                        target="_blank"
                        class="inline-flex items-center px-4 py-2 bg-yellow-400/30 hover:bg-yellow-500/40 text-yellow-100 rounded-lg text-sm font-semibold transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            class="w-5 h-5 mr-2">
                            <path fill-rule="evenodd"
                                d="M2 5.75C2 5.336 2.336 5 2.75 5h14.5c.414 0 .75.336.75.75v9.5A1.75 1.75 0 0 1 16.25 17H3.75A1.75 1.75 0 0 1 2 15.25V5.75Zm3.5-1.5c0-.207.081-.406.228-.553.147-.146.346-.227.552-.227h9.44c.206 0 .405.081.552.227.147.147.228.346.228.553V4.5H5.5v-.25Zm-2 3.25a.75.75 0 0 0 0 1.5h13a.75.75 0 0 0 0-1.5h-13Z"
                                clip-rule="evenodd" />
                        </svg>
                        Open Full Calendar
                    </a>
                </div>
            </div>
        </div>
    </main>

    <footer class="py-12 mt-16 glass relative z-10">
        <div class="container mx-auto px-6 text-center">
            <div class="flex justify-center items-center mb-4">
                <div class="w-2 h-2 bg-white rounded-full mx-1 animate-pulse"></div>
                <div class="w-2 h-2 bg-white rounded-full mx-1 animate-pulse" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 bg-white rounded-full mx-1 animate-pulse" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-white font-medium">MCYM Bonn/K√∂ln</p>
            <p class="text-white/60 text-sm mt-2">Building Faith ‚Ä¢ Inspiring Youth ‚Ä¢ Serving Community</p>

        </div>
    </footer>

    <script>
        // ====================================
        // DUAL API KEY CONFIGURATION - LATEST VERSION
        // ====================================
        const CONFIG = {
            // WEBSITE API KEY: Replace with your RESTRICTED API key (different from GitHub Actions)
            // This key should be restricted to your GitHub Pages domain in Google Cloud Console
            GOOGLE_API_KEY: 'AIzaSyCKG5EWSl4hrKPrZ-LaB3G5BHIITA29oA8', // üîë REPLACE THIS WITH YOUR RESTRICTED KEY
            CALENDAR_ID: 'ce68c51efd70dea3bb00658ca61427f860a2902e62894b09434ef0ba6b881b05@group.calendar.google.com',

            // Hybrid behavior settings
            ENABLE_LIVE_FALLBACK: true, // Set to true after adding API credentials
            MAX_CACHE_AGE_HOURS: 0, // Use live API if static data is older than this

            // Performance settings
            AUTO_REFRESH_MINUTES: 20, // How often to auto-refresh page
            RETRY_ATTEMPTS: 3, // How many times to retry failed requests
            UPCOMING_EVENT_LIMIT: 12, // Number of upcoming events to display

            // üõ°Ô∏è ANTI-ABUSE PROTECTION SETTINGS
            REFRESH_COOLDOWN_SECONDS: 30, // Minimum seconds between manual refreshes
            MAX_REFRESHES_PER_HOUR: 5, // Maximum manual refreshes allowed per hour
            ABUSE_BLOCK_HOURS: 1, // Hours to block after abuse detection
            ENABLE_BOT_DETECTION: true // Automatically hide refresh button for detected bots
        };

        // Global variables
        let calendarData = null;
        let isLoading = true;
        let autoRefreshIntervalId = null;

        // üõ°Ô∏è Anti-abuse protection variables
        let lastRefreshTime = 0;
        let refreshAttempts = 0;
        let isRefreshBlocked = false;

        // ====================================
        // MAIN DATA FETCHING LOGIC (ENHANCED & FIXED)
        // ====================================
        async function fetchCalendarEvents() {
            console.log('üîç Starting hybrid calendar data fetch...');
            updateStatus('upcoming', 'Fetching calendar data...');

            let staticData = null;
            let staticDataError = null;

            try {
                // STEP 1: Try to get static data first (graceful failure if missing)
                console.log('üìÅ Attempting to fetch static data from GitHub Actions...');
                try {
                    staticData = await fetchStaticCalendarData();
                    console.log('‚úÖ Static data fetched successfully');
                } catch (error) {
                    staticDataError = error;
                    console.warn('‚ö†Ô∏è Static data fetch failed:', error.message);
                }

                // STEP 2: Check if static data is fresh enough
                if (staticData) {
                    const dataAge = calculateDataAge(staticData.lastUpdated);
                    console.log(`‚è∞ Static data age: ${dataAge.hours} hours, ${dataAge.minutes} minutes`);

                    if (dataAge.hours < CONFIG.MAX_CACHE_AGE_HOURS) {
                        console.log('‚úÖ Using fresh static data');
                        updateStatus('live', `Calendar loaded ‚Ä¢ ${staticData.totalEvents || staticData.events.length} events ‚Ä¢ Updated ${dataAge.hours > 0 ? `${dataAge.hours}h ` : ''}${dataAge.minutes}m ago`);
                        updateLastUpdated(staticData.lastUpdated);
                        return staticData.events;
                    }
                }

                // STEP 3: Static data is old/missing - try live API if enabled
                if (CONFIG.ENABLE_LIVE_FALLBACK && CONFIG.GOOGLE_API_KEY && CONFIG.CALENDAR_ID) {
                    console.log('üîÑ Static data is old/missing, fetching live data...');
                    return await fetchLiveCalendarEventsWithRetry();
                }

                // STEP 4: Live API not available - use old static data with warning (if available)
                if (staticData) {
                    const dataAge = calculateDataAge(staticData.lastUpdated);
                    console.warn('‚ö†Ô∏è Using old static data (live API not enabled and static data is stale)');
                    updateStatus('warning', `Displaying cached data ‚Ä¢ ${staticData.events.length} events ‚Ä¢ Data is ${dataAge.hours}h ${dataAge.minutes}m old`);
                    updateLastUpdated(staticData.lastUpdated);
                    return staticData.events;
                }

                // STEP 5: No data sources available
                throw new Error('No calendar data available. Static file not found and live API not configured.');

            } catch (error) {
                console.error('‚ùå All data sources failed:', error);
                updateStatus('error', 'Failed to load calendar data. Please try again.');

                // Attempt to display previously cached data if available
                if (calendarData && calendarData.events) {
                    console.warn('Displaying previously cached data due to full fetch failure.');
                    return calendarData.events;
                }
                throw error;
            }
        }

        // ====================================
        // LIVE API SOURCE WITH RETRY LOGIC
        // ====================================
        async function fetchLiveCalendarEventsWithRetry(attempt = 1) {
            try {
                return await fetchLiveCalendarEvents();
            } catch (error) {
                console.warn(`Live API fetch attempt ${attempt} failed:`, error.message);
                if (attempt < CONFIG.RETRY_ATTEMPTS) {
                    await new Promise(resolve => setTimeout(resolve, attempt * 1000)); // Exponential backoff
                    return fetchLiveCalendarEventsWithRetry(attempt + 1);
                }
                console.error('‚ùå Live API fetch failed after multiple retries.');
                throw error;
            }
        }

        async function fetchLiveCalendarEvents() {
            updateStatus('upcoming', 'üîÑ Loading live calendar data...');

            const now = new Date().toISOString();
            const future = new Date(Date.now() + 3 * 30 * 24 * 60 * 60 * 1000).toISOString(); // 3 months

            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CONFIG.CALENDAR_ID)}/events?key=${CONFIG.GOOGLE_API_KEY}&timeMin=${now}&timeMax=${future}&singleEvents=true&orderBy=startTime&maxResults=50`;

            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('Google API Error Response:', errorData);
                throw new Error(`Google API error: ${response.status} - ${errorData.error?.message || 'Unknown API error'}`);
            }

            const data = await response.json();
            const events = data.items ? data.items.map(event => ({
                id: event.id,
                title: event.summary || 'Untitled Event',
                description: (event.description || '').replace(/<[^>]*>/g, '').substring(0, 300),
                start: event.start ? (event.start.dateTime || event.start.date) : null,
                end: event.end ? (event.end.dateTime || event.end.date) : null,
                location: event.location || '',
                htmlLink: event.htmlLink || '',
                created: event.created,
                updated: event.updated,
                recurringEventId: event.recurringEventId
            })).filter(event => event.start) : [];

            console.log(`üî¥ Live API data loaded: ${events.length} events`);
            updateStatus('live', `Live data loaded ‚Ä¢ ${events.length} events`);

            calendarData = {
                lastUpdated: new Date().toISOString(),
                events: events,
                source: 'live-api',
                totalEvents: events.length
            };
            updateLastUpdated(calendarData.lastUpdated);

            return events;
        }

        // ====================================
        // STATIC DATA SOURCE WITH IMPROVED ERROR HANDLING
        // ====================================
        async function fetchStaticCalendarData() {
            const response = await fetch('./data/events.json', {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    console.warn('üìÅ Events file (events.json) not found - this is normal if using live API only');
                    throw new Error('STATIC_FILE_NOT_FOUND');
                }
                throw new Error(`Failed to load static calendar data: HTTP ${response.status}`);
            }

            const data = await response.json();
            if (!data.events || !data.lastUpdated) {
                console.error('Static data is malformed:', data);
                throw new Error('Static calendar data is incomplete or malformed.');
            }
            console.log(`üìä Static data loaded: ${data.events.length} events from ${data.source || 'GitHub Actions'}`);

            calendarData = data;
            return data;
        }

        // ====================================
        // üõ°Ô∏è ANTI-ABUSE PROTECTION FUNCTIONS
        // ====================================
        function isRefreshAllowed() {
            const now = Date.now();
            const REFRESH_COOLDOWN = CONFIG.REFRESH_COOLDOWN_SECONDS * 1000;
            const MAX_REFRESH_ATTEMPTS = CONFIG.MAX_REFRESHES_PER_HOUR;
            const ABUSE_BLOCK_TIME = CONFIG.ABUSE_BLOCK_HOURS * 3600000;

            // Check if currently blocked for abuse
            if (isRefreshBlocked) {
                console.warn('üö´ Refresh blocked due to abuse detection');
                return false;
            }

            // Check cooldown period
            if (now - lastRefreshTime < REFRESH_COOLDOWN) {
                const remainingTime = Math.ceil((REFRESH_COOLDOWN - (now - lastRefreshTime)) / 1000);
                console.warn(`‚è∞ Refresh cooldown active. Try again in ${remainingTime} seconds`);
                updateStatus('warning', `Please wait ${remainingTime}s before refreshing again`);
                return false;
            }

            // Reset attempt counter after 1 hour
            if (now - lastRefreshTime > 3600000) {
                refreshAttempts = 0;
            }

            // Check attempt limit
            if (refreshAttempts >= MAX_REFRESH_ATTEMPTS) {
                console.error(`üö´ Too many refresh attempts (${MAX_REFRESH_ATTEMPTS}). Blocking for ${CONFIG.ABUSE_BLOCK_HOURS} hour(s).`);
                isRefreshBlocked = true;
                updateStatus('error', `Too many refresh attempts. Please wait ${CONFIG.ABUSE_BLOCK_HOURS} hour(s).`);

                // Unblock after configured time
                setTimeout(() => {
                    isRefreshBlocked = false;
                    refreshAttempts = 0;
                    console.log('‚úÖ Refresh blocking lifted');
                }, ABUSE_BLOCK_TIME);

                return false;
            }

            return true;
        }

        function updateRefreshButton(state, text, disabled = false) {
            const refreshBtn = document.getElementById('refresh-btn');
            if (!refreshBtn) return;

            refreshBtn.disabled = disabled;
            refreshBtn.innerHTML = text;

            if (disabled) {
                refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // ====================================
        // ü§ñ BOT DETECTION FUNCTION
        // ====================================
        function detectBot() {
            if (!CONFIG.ENABLE_BOT_DETECTION) {
                return false;
            }

            const userAgent = navigator.userAgent.toLowerCase();
            const botPatterns = [
                'bot', 'crawl', 'spider', 'scrape', 'wget', 'curl',
                'http', 'python', 'java', 'go-http', 'node', 'phantom'
            ];

            const isBot = botPatterns.some(pattern => userAgent.includes(pattern));
            const hasWebdriver = 'webdriver' in navigator || navigator.webdriver;
            const isHeadless = /headless/i.test(userAgent);

            if (isBot || hasWebdriver || isHeadless) {
                console.warn('ü§ñ Potential bot detected, disabling manual refresh');
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }
                return true;
            }

            return false;
        }

        // ====================================
        // ENHANCED REFRESH FUNCTIONALITY WITH PROTECTION
        // ====================================
        async function refreshCalendar() {
            // üõ°Ô∏è Anti-abuse check
            if (!isRefreshAllowed()) {
                return;
            }

            const refreshBtn = document.getElementById('refresh-btn');
            if (!refreshBtn) return;

            // Record this refresh attempt
            lastRefreshTime = Date.now();
            refreshAttempts++;

            const originalContent = refreshBtn.innerHTML;
            updateRefreshButton('loading', `<svg class="animate-spin h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Refreshing...</span>`, true);
            isLoading = true;

            try {
                console.log('üîÑ Manual refresh triggered');
                let events;
                if (CONFIG.ENABLE_LIVE_FALLBACK && CONFIG.GOOGLE_API_KEY && CONFIG.CALENDAR_ID) {
                    console.log('üî¥ Forcing live API call for manual refresh');
                    events = await fetchLiveCalendarEventsWithRetry();
                } else {
                    console.log('üìÅ Refreshing static data (cache-bypassed)');
                    const staticData = await fetchStaticCalendarData();
                    events = staticData.events;
                    updateLastUpdated(staticData.lastUpdated);
                }

                const upcomingEvents = getUpcomingEvents(events);
                displayEvents(upcomingEvents);

                updateRefreshButton('success', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1.5"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" /></svg><span>Updated!</span>`, true);
            } catch (error) {
                console.error('‚ùå Manual refresh failed:', error);
                updateStatus('error', 'Refresh failed. Please try again.');
                updateRefreshButton('error', `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1.5"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" /></svg><span>Failed</span>`, true);

                // Show error message
                displayEvents([]);
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loadingEvents').style.display = 'none';
                document.getElementById('noEventsMessage').style.display = 'none';
                document.getElementById('upcomingEvents').style.display = 'none';
            } finally {
                // Re-enable button after cooldown
                setTimeout(() => {
                    updateRefreshButton('normal', originalContent, false);
                }, 2500);
                isLoading = false;
            }
        }

        // ====================================
        // UTILITY FUNCTIONS
        // ====================================
        function calculateDataAge(lastUpdatedString) {
            if (!lastUpdatedString) return { hours: Infinity, minutes: Infinity, totalMs: Infinity };
            const now = new Date();
            const updated = new Date(lastUpdatedString);
            if (isNaN(updated.getTime())) return { hours: Infinity, minutes: Infinity, totalMs: Infinity };

            const diffMs = now - updated;
            return {
                hours: Math.floor(diffMs / (1000 * 60 * 60)),
                minutes: Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60)),
                totalMs: diffMs
            };
        }

        function updateStatus(status, message) {
            const statusIndicator = document.getElementById('calendar-status');
            const statusText = document.getElementById('status-text');

            if (statusIndicator) statusIndicator.className = `status-indicator status-${status}`;
            if (statusText) statusText.textContent = message;
        }

        function updateLastUpdated(timestamp) {
            const lastUpdatedEl = document.getElementById('last-updated');
            if (timestamp && lastUpdatedEl) {
                try {
                    const date = new Date(timestamp);
                    if (isNaN(date.getTime())) {
                        lastUpdatedEl.textContent = 'Last update time unknown';
                        return;
                    }
                    const timeAgo = getTimeAgo(date);
                    lastUpdatedEl.textContent = `Updated ${timeAgo}`;
                } catch (e) {
                    lastUpdatedEl.textContent = 'Error displaying update time';
                    console.error("Error parsing lastUpdated timestamp:", timestamp, e);
                }
            } else if (lastUpdatedEl) {
                lastUpdatedEl.textContent = '';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffSeconds = Math.floor(diffTime / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMinutes < 1) return 'just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ${diffMinutes % 60}m ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // ====================================
        // EVENT PROCESSING FUNCTIONS
        // ====================================
        function getUpcomingEvents(events) {
            if (!Array.isArray(events)) return [];
            const now = new Date();
            return events
                .filter(event => {
                    if (!event || !event.start) return false;
                    const eventDate = new Date(event.start);
                    return !isNaN(eventDate.getTime()) && eventDate >= now;
                })
                .sort((a, b) => new Date(a.start) - new Date(b.start))
                .slice(0, CONFIG.UPCOMING_EVENT_LIMIT);
        }

        function formatEventDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const options = { weekday: 'long', month: 'long', day: 'numeric' };

            if (date.toDateString() === today.toDateString()) {
                return `Today, ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return `Tomorrow, ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
            } else {
                return date.toLocaleDateString('en-US', options);
            }
        }

        function getDateDay(dateString) {
            return new Date(dateString).getDate();
        }

        function getDateMonthYear(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function formatEventTime(dateString) {
            if (dateString && dateString.length === 10 && !dateString.includes('T')) {
                return "All day";
            }
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // ====================================
        // üÜï FIXED COUNTDOWN LOGIC - THE KEY FIX!
        // ====================================
        function getEnhancedTimeUntilEvent(dateString) {
            const now = new Date();
            const eventDate = new Date(dateString);
            const diffTime = eventDate - now;

            if (diffTime < 0) return { text: "Event has passed", cssClass: "countdown-later opacity-70" };

            // üîß FIXED: Compare actual calendar dates, not just time difference
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());

            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffTime % (1000 * 60 * 60)) / (1000 * 60));
            const remainingHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            let text, cssClass;

            if (eventDay.getTime() === today.getTime()) { // Actually today
                if (diffHours < 1 && diffMinutes > 0) {
                    text = `In ${diffMinutes} min${diffMinutes > 1 ? 's' : ''}`;
                } else if (diffHours < 1 && diffMinutes <= 0) {
                    text = "Starting now!";
                } else {
                    text = `Today in ${remainingHours}h`;
                }
                cssClass = "countdown-today";
            } else if (eventDay.getTime() === tomorrow.getTime()) { // Actually tomorrow
                if (diffHours < 24) {
                    text = `Tomorrow in ${remainingHours}h`;
                } else {
                    text = "Tomorrow";
                }
                cssClass = "countdown-tomorrow";
            } else {
                // Calculate actual day difference using calendar dates
                const dayDiff = Math.floor((eventDay - today) / (1000 * 60 * 60 * 24));

                if (dayDiff <= 7) {
                    text = `In ${dayDiff} day${dayDiff > 1 ? 's' : ''}`;
                    cssClass = "countdown-soon";
                } else if (dayDiff <= 30) {
                    const weeks = Math.ceil(dayDiff / 7);
                    text = `In ${weeks} week${weeks > 1 ? 's' : ''}`;
                    cssClass = "countdown-later";
                } else {
                    const months = Math.ceil(dayDiff / 30);
                    text = `In ${months} month${months > 1 ? 's' : ''}`;
                    cssClass = "countdown-later";
                }
            }
            return { text, cssClass };
        }

        function createAddToCalendarUrl(event) {
            const startDate = new Date(event.start);
            const endDate = event.end ? new Date(event.end) : new Date(startDate.getTime() + (60 * 60 * 1000));

            const formatGoogleDate = (date) => date.toISOString().replace(/[-:.]/g, '').slice(0, -4) + 'Z';

            let datesParam;
            if ((event.start.length === 10 && !event.start.includes('T')) || (startDate.getHours() === 0 && startDate.getMinutes() === 0 && startDate.getSeconds() === 0)) {
                const nextDay = new Date(startDate);
                nextDay.setDate(startDate.getDate() + 1);
                datesParam = `${startDate.toISOString().slice(0, 10).replace(/-/g, '')}/${nextDay.toISOString().slice(0, 10).replace(/-/g, '')}`;
            } else {
                datesParam = `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            }

            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: event.title,
                dates: datesParam,
                details: (event.description || '').substring(0, 500) + (event.htmlLink ? `\n\nMore info: ${event.htmlLink}` : ''),
                location: event.location || '',
                ctz: 'Europe/Berlin'
            });
            return `https://calendar.google.com/calendar/render?${params.toString()}`;
        }

        function getEventBadge(title, description = '', manualBadge = null) {
            if (manualBadge && ['mass', 'retreat', 'service', 'prayer', 'youth', 'social', 'meeting', 'special'].includes(manualBadge.toLowerCase())) {
                return manualBadge.toLowerCase();
            }

            const text = (String(title) + ' ' + String(description)).toLowerCase();

            if (text.includes('mass') || text.includes('holy qurbana') || text.includes('qurbana') || text.includes('liturgy') || text.includes('eucharist')) {
                return 'mass';
            }
            if (text.includes('retreat') || text.includes('formation') || text.includes('workshop') || text.includes('seminar')) {
                return 'retreat';
            }
            if (text.includes('service') || text.includes('volunteer') || text.includes('charity') || text.includes('outreach') || text.includes('food drive') || text.includes('donation')) {
                return 'service';
            }
            if (text.includes('prayer') || text.includes('adoration') || text.includes('rosary') || text.includes('vigil') || text.includes('novena')) {
                return 'prayer';
            }
            if (text.includes('youth') || text.includes('fellowship') || text.includes('social') || text.includes('gathering') || text.includes('meeting')) {
                return 'youth';
            }
            if (text.includes('bible') || text.includes('scripture') || text.includes('study')) {
                return 'meeting';
            }

            return 'special';
        }

        function createEventCard(event) {
            const badgeType = getEventBadge(event.title, event.description, event.badge);
            const eventTime = formatEventTime(event.start);
            const eventDate = formatEventDate(event.start);
            const dateDay = getDateDay(event.start);
            const dateMonthYear = getDateMonthYear(event.start);
            const countdown = getEnhancedTimeUntilEvent(event.start); // üîß NOW USES FIXED LOGIC!
            const addToCalendarUrl = createAddToCalendarUrl(event);

            const description = event.description ?
                (event.description.length > 100 ?
                    event.description.substring(0, 97) + '...' :
                    event.description) : '';

            return `
                <div class="event-card bg-white shadow-lg flex flex-col">
                    <div class="event-header">
                        <div class="relative z-10">
                            <span class="event-badge badge-${badgeType}">${badgeType.replace(/^\w/, c => c.toUpperCase())}</span>
                            <div class="event-date-block">
                                <div class="event-day">${dateDay}</div>
                                <div class="event-month-year">${dateMonthYear}</div>
                            </div>
                            <div class="countdown-badge ${countdown.cssClass}">
                                ${countdown.text}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-content flex flex-col flex-grow">
                        <h3 class="event-title">${event.title || 'Event Title Missing'}</h3>
                        
                        <div class="event-details">
                            <div class="event-detail-item">
                                <svg class="event-detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span><strong>${eventDate}</strong></span>
                            </div>
                            <div class="event-detail-item">
                                <svg class="event-detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span><strong>${eventTime}</strong></span>
                            </div>
                            ${event.location ? `
                                <div class="event-detail-item">
                                    <svg class="event-detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    <span>${event.location}</span>
                                </div>` : ''}
                        </div>
                        
                        <div class="event-description ${description ? '' : 'event-description-empty'} flex-grow mb-4">
                            ${description ? `
                                <div class="event-detail-item items-start"> <svg class="event-detail-icon mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span>${description}</span>
                                </div>` : '<p class="text-gray-500 text-sm italic">No additional details provided for this event.</p>'}
                        </div>
                        
                        <div class="event-actions mt-auto">
                            <a href="${addToCalendarUrl}" target="_blank" class="event-action-btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline mr-1.5 -mt-0.5"><path d="M5.75 3.5a.75.75 0 0 0-.75.75v1.5h9.5v-1.5a.75.75 0 0 0-.75-.75h-8Z" /><path fill-rule="evenodd" d="M3 8.75A.75.75 0 0 1 3.75 8h12.5a.75.75 0 0 1 .75.75v5.5A2.75 2.75 0 0 1 14.25 17H5.75A2.75 2.75 0 0 1 3 14.25v-5.5ZM12.75 12a.75.75 0 0 0-.75-.75H8a.75.75 0 0 0-.75.75v.001c0 .414.336.75.75.75h4a.75.75 0 0 0 .75-.75V12Z" clip-rule="evenodd" /></svg>
                                Add to Calendar
                            </a>
                            ${event.htmlLink ? `
                                <a href="${event.htmlLink}" target="_blank" class="event-action-btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline mr-1.5 -mt-0.5"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .976-1.138 2.5 2.5 0 0 1-.142-3.665l3-3Z" /><path d="M8.603 17.03a4 4 0 0 0 5.656-5.656l-1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.06-1.061l-1.225 1.223a4 4 0 0 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865.75.75 0 0 0-.976 1.138 2.5 2.5 0 0 1 .142 3.665l-3 3Z" /></svg>
                                    View Details
                                </a>` : ''}
                        </div>
                    </div>
                </div>`;
        }

        // ====================================
        // DISPLAY FUNCTIONS
        // ====================================
        function displayEvents(upcomingEvents) {
            const upcomingEventsContainer = document.getElementById('upcomingEvents');
            const loadingContainer = document.getElementById('loadingEvents');
            const noEventsMessage = document.getElementById('noEventsMessage');
            const errorMessage = document.getElementById('errorMessage');
            const upcomingTitle = document.getElementById('upcomingEventsTitle');

            if (loadingContainer) loadingContainer.style.display = 'none';
            if (errorMessage) errorMessage.style.display = 'none';

            if (!Array.isArray(upcomingEvents)) {
                console.error("displayEvents called with non-array:", upcomingEvents);
                if (errorMessage) errorMessage.style.display = 'block';
                if (upcomingEventsContainer) upcomingEventsContainer.style.display = 'none';
                if (noEventsMessage) noEventsMessage.style.display = 'none';
                if (upcomingTitle) upcomingTitle.innerHTML = `Error loading events.`;
                return;
            }

            if (upcomingTitle) {
                if (upcomingEvents.length > 0) {
                    upcomingTitle.innerHTML = `Discover Our Next <span class="font-semibold gradient-text">${upcomingEvents.length}</span> Activities`;
                }
            }

            if (upcomingEvents.length === 0) {
                if (noEventsMessage) noEventsMessage.style.display = 'block';
                if (upcomingEventsContainer) upcomingEventsContainer.style.display = 'none';
            } else {
                if (upcomingEventsContainer) {
                    upcomingEventsContainer.innerHTML = upcomingEvents
                        .map(event => createEventCard(event))
                        .join('');

                    let gridClasses = 'grid gap-6 ';
                    if (upcomingEvents.length === 1) {
                        gridClasses += 'max-w-xl mx-auto';
                    } else if (upcomingEvents.length === 2) {
                        gridClasses += 'md:grid-cols-2 max-w-4xl mx-auto';
                    } else if (upcomingEvents.length === 3) {
                        gridClasses += 'md:grid-cols-2 lg:grid-cols-3 max-w-7xl mx-auto';
                    } else {
                        gridClasses += 'md:grid-cols-2 lg:grid-cols-3';
                    }
                    upcomingEventsContainer.className = gridClasses;
                    upcomingEventsContainer.style.display = 'grid';
                }
                if (noEventsMessage) noEventsMessage.style.display = 'none';
            }
        }

        async function displayUpcomingEvents() {
            isLoading = true;
            try {
                const events = await fetchCalendarEvents();
                const upcomingEvents = getUpcomingEvents(events);
                displayEvents(upcomingEvents);
            } catch (error) {
                console.error('Error displaying events:', error.message);

                const loadingContainer = document.getElementById('loadingEvents');
                const errorMessageContainer = document.getElementById('errorMessage');
                const upcomingEventsContainer = document.getElementById('upcomingEvents');
                const noEventsMessageContainer = document.getElementById('noEventsMessage');

                if (loadingContainer) loadingContainer.style.display = 'none';
                if (errorMessageContainer) errorMessageContainer.style.display = 'block';
                if (upcomingEventsContainer) upcomingEventsContainer.style.display = 'none';
                if (noEventsMessageContainer) noEventsMessageContainer.style.display = 'none';
                updateStatus('error', error.message || 'Failed to load events.');
            } finally {
                isLoading = false;
            }
        }

        // ====================================
        // VISUAL EFFECTS & ANIMATIONS
        // ====================================
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 5 + 3;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDuration = `${Math.random() * 15 + 10}s`;
            particle.style.animationDelay = `${Math.random() * 5}s`;
            particle.style.opacity = (Math.random() * 0.5 + 0.3).toFixed(2);

            const container = document.getElementById('particles-container');
            if (container) {
                container.appendChild(particle);
                setTimeout(() => particle.remove(), parseFloat(particle.style.animationDuration) * 1000 + parseFloat(particle.style.animationDelay) * 1000 + 1000);
            }
        }

        function initScrollReveal() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -30px 0px'
            };
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        obs.unobserve(entry.target);
                    }
                });
            }, observerOptions);
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }

        function setFooterYear() {
            const yearEl = document.getElementById('currentYear');
            if (yearEl) yearEl.textContent = new Date().getFullYear();
        }

        // ====================================
        // INITIALIZATION WITH FULL PROTECTION
        // ====================================
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Initializing MCYM hybrid calendar system v3 (LATEST)...');
            console.log('‚öôÔ∏è Configuration:', {
                liveEnabled: CONFIG.ENABLE_LIVE_FALLBACK,
                maxCacheAge: `${CONFIG.MAX_CACHE_AGE_HOURS}h`,
                autoRefresh: `${CONFIG.AUTO_REFRESH_MINUTES}m`,
                eventLimit: CONFIG.UPCOMING_EVENT_LIMIT,
                antiAbuse: `${CONFIG.REFRESH_COOLDOWN_SECONDS}s cooldown, max ${CONFIG.MAX_REFRESHES_PER_HOUR}/hour`,
                botDetection: CONFIG.ENABLE_BOT_DETECTION
            });
            console.log('üîÑ Data strategy: Static-first with live API fallback');
            console.log('üõ°Ô∏è Anti-abuse protection: ENABLED');
            console.log('ü§ñ Bot detection: ENABLED');

            // ü§ñ Bot detection
            const isBot = detectBot();
            if (isBot) {
                console.log('ü§ñ Bot detected - showing static data only');
            }

            displayUpcomingEvents();
            setFooterYear();

            // Only set up auto-refresh for real users
            if (!isBot) {
                if (autoRefreshIntervalId) clearInterval(autoRefreshIntervalId);
                autoRefreshIntervalId = setInterval(() => {
                    if (!isLoading && document.visibilityState === 'visible') {
                        console.log('üîÑ Auto-refresh triggered by interval.');
                        displayUpcomingEvents();
                    }
                }, CONFIG.AUTO_REFRESH_MINUTES * 60 * 1000);
            }

            initScrollReveal();

            // Create initial burst of particles, then periodically
            for (let i = 0; i < 8; i++) {
                setTimeout(createParticle, i * 500);
            }
            setInterval(createParticle, 2500);

            // Smooth scroll for internal links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const hrefAttribute = this.getAttribute('href');
                    if (hrefAttribute && hrefAttribute !== "#") {
                        const targetElement = document.querySelector(hrefAttribute);
                        if (targetElement) {
                            e.preventDefault();
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            });

            // üõ°Ô∏è Add keyboard shortcut protection
            document.addEventListener('keydown', function (e) {
                // Prevent F5/Ctrl+R abuse by adding cooldown
                if ((e.key === 'F5' || (e.ctrlKey && e.key === 'r')) && !isRefreshAllowed()) {
                    e.preventDefault();
                    console.warn('‚è∞ Page refresh blocked due to cooldown');
                }
            });
        });
    </script>

</body>

</html>